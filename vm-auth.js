// Generated by CoffeeScript 1.12.2
(function() {
  var PouchDB, crypto, debug, hex_hmac_sha1, jsonBody, seem;

  seem = require('seem');

  PouchDB = require('shimaore-pouchdb');

  jsonBody = (require('body-parser')).json({});

  this.name = (require('./package')).name + ":vm-auth";

  debug = (require('debug'))(this.name);

  this.include = function() {
    return this.post('/vm-auth', jsonBody, seem(function*() {
      var db_uri, new_number, number, number_data, number_domain, pin, ref, user_database, user_id, vm_db, vm_settings;
      if (this.session.couchdb_token != null) {
        this.res.status(400);
        this.json({
          error: 'Already authenticated'
        });
        return;
      }
      ref = this.body, number = ref.number, number_domain = ref.number_domain, pin = ref.pin;
      if (!((number != null) && (number_domain != null) && (pin != null) && typeof number === 'string' && typeof number_domain === 'string' && typeof pin === 'string')) {
        this.res.status(400);
        this.json({
          error: 'Invalid parameters',
          parameters: this.body
        });
        return;
      }
      debug('before translation', {
        number: number,
        number_domain: number_domain
      });
      new_number = (yield (typeof this.translate_local_number === "function" ? this.translate_local_number(number, number_domain) : void 0));
      if (new_number != null) {
        number = new_number;
      }
      debug('after translation', {
        number: number,
        number_domain: number_domain
      });
      user_id = number + "@" + number_domain;
      number_data = (yield this.cfg.prov.get("number:" + user_id)["catch"](function(error) {
        return {};
      }).then(function(data) {
        if (data != null ? data.disabled : void 0) {
          return {};
        } else {
          return data;
        }
      }));
      if ((number_data != null ? number_data._id : void 0) == null) {
        debug('No _id in', {
          number_data: number_data
        });
        this.res.status(404).end();
        return;
      }
      user_database = number_data.user_database;
      if (user_database == null) {
        debug('No user_database in', {
          number_data: number_data
        });
        this.res.status(404).end();
        return;
      }
      db_uri = this.cfg.userdb_base_uri + '/' + user_database;
      vm_db = new PouchDB(db_uri);
      vm_settings = (yield vm_db.get('voicemail_settings')["catch"](function(error) {
        return {};
      }));
      yield vm_db.close();
      if (!((vm_settings.pin != null) && vm_settings.pin === pin)) {
        this.res.status(404).end();
      }
      this.session.couchdb_username = user_id;
      this.session.couchdb_roles = ["number:" + user_id, "user_database:" + user_database];
      this.session.full_name = user_id;
      this.session.couchdb_token = hex_hmac_sha1(this.cfg.couchdb_secret, this.session.couchdb_username);
      return this.json({
        ok: true,
        username: this.session.couchdb_username,
        roles: this.session.couchdb_roles
      });
    }));
  };

  crypto = require('crypto');

  hex_hmac_sha1 = function(key, value) {
    var hmac;
    hmac = crypto.createHmac('sha1', key);
    hmac.update(value);
    return hmac.digest('hex');
  };

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidm0tYXV0aC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInZtLWF1dGguY29mZmVlLm1kIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBSTtBQUFBLE1BQUE7O0VBQUEsSUFBQSxHQUFPLE9BQUEsQ0FBUSxNQUFSOztFQUNQLE9BQUEsR0FBVSxPQUFBLENBQVEsa0JBQVI7O0VBQ1YsUUFBQSxHQUFXLENBQUMsT0FBQSxDQUFRLGFBQVIsQ0FBRCxDQUF1QixDQUFDLElBQXhCLENBQTZCLEVBQTdCOztFQUVYLElBQUMsQ0FBQSxJQUFELEdBQVcsQ0FBQyxPQUFBLENBQVEsV0FBUixDQUFELENBQXFCLENBQUMsSUFBdkIsR0FBNEI7O0VBQ3RDLEtBQUEsR0FBUyxDQUFDLE9BQUEsQ0FBUSxPQUFSLENBQUQsQ0FBQSxDQUFrQixJQUFDLENBQUEsSUFBbkI7O0VBRVQsSUFBQyxDQUFBLE9BQUQsR0FBVyxTQUFBO1dBS1QsSUFBQyxDQUFBLElBQUQsQ0FBTSxVQUFOLEVBQWtCLFFBQWxCLEVBQTRCLElBQUEsQ0FBSyxVQUFBO0FBRS9CLFVBQUE7TUFBQSxJQUFHLGtDQUFIO1FBQ0UsSUFBQyxDQUFBLEdBQUcsQ0FBQyxNQUFMLENBQVksR0FBWjtRQUNBLElBQUMsQ0FBQSxJQUFELENBQU07VUFBQSxLQUFBLEVBQU0sdUJBQU47U0FBTjtBQUNBLGVBSEY7O01BT0EsTUFBNkIsSUFBQyxDQUFBLElBQTlCLEVBQUMsbUJBQUQsRUFBUSxpQ0FBUixFQUFzQjtNQUl0QixJQUFBLENBQUEsQ0FBTyxnQkFBQSxJQUFZLHVCQUFaLElBQStCLGFBQS9CLElBQ0gsT0FBTyxNQUFQLEtBQWlCLFFBRGQsSUFFSCxPQUFPLGFBQVAsS0FBd0IsUUFGckIsSUFHSCxPQUFPLEdBQVAsS0FBYyxRQUhsQixDQUFBO1FBSUUsSUFBQyxDQUFBLEdBQUcsQ0FBQyxNQUFMLENBQVksR0FBWjtRQUNBLElBQUMsQ0FBQSxJQUFELENBQU07VUFBQSxLQUFBLEVBQU0sb0JBQU47VUFBNEIs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RUFIYztBQXhHaEIiLCJzb3VyY2VzQ29udGVudCI6WyIgICAgc2VlbSA9IHJlcXVpcmUgJ3NlZW0nXG4gICAgUG91Y2hEQiA9IHJlcXVpcmUgJ3NoaW1hb3JlLXBvdWNoZGInXG4gICAganNvbkJvZHkgPSAocmVxdWlyZSAnYm9keS1wYXJzZXInKS5qc29uIHt9XG5cbiAgICBAbmFtZSA9IFwiI3socmVxdWlyZSAnLi9wYWNrYWdlJykubmFtZX06dm0tYXV0aFwiXG4gICAgZGVidWcgID0gKHJlcXVpcmUgJ2RlYnVnJykgQG5hbWVcblxuICAgIEBpbmNsdWRlID0gLT5cblxuQXV0aGVudGljYXRlIHVzaW5nIG51bWJlciBhbmQgdm9pY2VtYWlsIFBJTlxuLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gICAgICBAcG9zdCAnL3ZtLWF1dGgnLCBqc29uQm9keSwgc2VlbSAtPlxuXG4gICAgICAgIGlmIEBzZXNzaW9uLmNvdWNoZGJfdG9rZW4/XG4gICAgICAgICAgQHJlcy5zdGF0dXMgNDAwXG4gICAgICAgICAgQGpzb24gZXJyb3I6J0FscmVhZHkgYXV0aGVudGljYXRlZCdcbiAgICAgICAgICByZXR1cm5cblxuU2VlIHdlbGwtZ3Jvb21lZC1mZWFzdC9zcmMvTWVzc2FnaW5nLmNvZmZlZS5tZCBmb3IgdGhlIHByb2Nlc3NcblxuICAgICAgICB7bnVtYmVyLG51bWJlcl9kb21haW4scGlufSA9IEBib2R5XG5cbkVuc3VyZSBhbGwgcGFyYW1ldGVycyBhcmUgcHJlc2VudFxuXG4gICAgICAgIHVubGVzcyBudW1iZXI/IGFuZCBudW1iZXJfZG9tYWluPyBhbmQgcGluPyAgYW5kXG4gICAgICAgICAgICB0eXBlb2YgbnVtYmVyIGlzICdzdHJpbmcnIGFuZFxuICAgICAgICAgICAgdHlwZW9mIG51bWJlcl9kb21haW4gaXMgJ3N0cmluZycgYW5kXG4gICAgICAgICAgICB0eXBlb2YgcGluIGlzICdzdHJpbmcnXG4gICAgICAgICAgQHJlcy5zdGF0dXMgNDAwXG4gICAgICAgICAgQGpzb24gZXJyb3I6J0ludmFsaWQgcGFyYW1ldGVycycsIHBhcmFtZXRlcnM6IEBib2R5XG4gICAgICAgICAgcmV0dXJuXG5cblRyYW5zbGF0ZSB0aGUgbG9jYWwgbnVtYmVyXG5cbiAgICAgICAgZGVidWcgJ2JlZm9yZSB0cmFuc2xhdGlvbicsIHtudW1iZXIsbnVtYmVyX2RvbWFpbn1cblxuICAgICAgICBuZXdfbnVtYmVyID0geWllbGQgQHRyYW5zbGF0ZV9sb2NhbF9udW1iZXI/IG51bWJlciwgbnVtYmVyX2RvbWFpblxuICAgICAgICBudW1iZXIgPSBuZXdfbnVtYmVyIGlmIG5ld19udW1iZXI/XG5cbiAgICAgICAgZGVidWcgJ2FmdGVyIHRyYW5zbGF0aW9uJywge251bWJlcixudW1iZXJfZG9tYWlufVxuXG4gICAgICAgIHVzZXJfaWQgPSBcIiN7bnVtYmVyfUAje251bWJlcl9kb21haW59XCJcblxuICAgICAgICBudW1iZXJfZGF0YSA9IHlpZWxkIEBjZmcucHJvdlxuICAgICAgICAgIC5nZXQgXCJudW1iZXI6I3t1c2VyX2lkfVwiXG4gICAgICAgICAgLmNhdGNoIChlcnJvcikgLT5cbiAgICAgICAgICAgIHt9XG4gICAgICAgICAgLnRoZW4gKGRhdGEpIC0+XG4gICAgICAgICAgICBpZiBkYXRhPy5kaXNhYmxlZCB0aGVuIHt9IGVsc2UgZGF0YVxuXG4gICAgICAgIHVubGVzcyBudW1iZXJfZGF0YT8uX2lkP1xuICAgICAgICAgIGRlYnVnICdObyBfaWQgaW4nLCB7bnVtYmVyX2RhdGF9XG4gICAgICAgICAgQHJlc1xuICAgICAgICAgICAgLnN0YXR1cyA0MDRcbiAgICAgICAgICAgIC5lbmQoKVxuICAgICAgICAgIHJldHVyblxuXG5SZXRyaWV2ZSB0aGUgdXNlciBkYXRhYmFzZVxuXG4gICAgICAgIHt1c2VyX2RhdGFiYXNlfSA9IG51bWJlcl9kYXRhXG5cbiAgICAgICAgdW5sZXNzIHVzZXJfZGF0YWJhc2U/XG4gICAgICAgICAgZGVidWcgJ05vIHVzZXJfZGF0YWJhc2UgaW4nLCB7bnVtYmVyX2RhdGF9XG4gICAgICAgICAgQHJlc1xuICAgICAgICAgICAgLnN0YXR1cyA0MDRcbiAgICAgICAgICAgIC5lbmQoKVxuICAgICAgICAgIHJldHVyblxuXG5SZXRyaWV2ZSB0aGUgdm9pY2VtYWlsLXNldHRpbmdzIGRvY3VtZW50XG5cbiAgICAgICAgZGJfdXJpID0gQGNmZy51c2VyZGJfYmFzZV91cmkgKyAnLycgKyB1c2VyX2RhdGFiYXNlXG4gICAgICAgIHZtX2RiID0gbmV3IFBvdWNoREIgZGJfdXJpXG5cbiAgICAgICAgdm1fc2V0dGluZ3MgPSB5aWVsZCB2bV9kYlxuICAgICAgICAgIC5nZXQgJ3ZvaWNlbWFpbF9zZXR0aW5ncydcbiAgICAgICAgICAuY2F0Y2ggKGVycm9yKSAtPlxuICAgICAgICAgICAge31cblxuICAgICAgICB5aWVsZCB2bV9kYi5jbG9zZSgpXG5cblZhbGlkYXRlIHRoZSBQSU5cblxuICAgICAgICB1bmxlc3Mgdm1fc2V0dGluZ3MucGluPyBhbmQgdm1fc2V0dGluZ3MucGluIGlzIHBpblxuICAgICAgICAgIEByZXNcbiAgICAgICAgICAgIC5zdGF0dXMgNDA0XG4gICAgICAgICAgICAuZW5kKClcblxuQXV0aGVudGljYXRlZCBPS1xuXG4gICAgICAgIEBzZXNzaW9uLmNvdWNoZGJfdXNlcm5hbWUgPSB1c2VyX2lkXG4gICAgICAgIEBzZXNzaW9uLmNvdWNoZGJfcm9sZXMgPSBbXG4gICAgICAgICAgXCJudW1iZXI6I3t1c2VyX2lkfVwiXG4gICAgICAgICAgXCJ1c2VyX2RhdGFiYXNlOiN7dXNlcl9kYXRhYmFzZX1cIlxuICAgICAgICBdXG4gICAgICAgIEBzZXNzaW9uLmZ1bGxfbmFtZSA9IHVzZXJfaWRcbiAgICAgICAgQHNlc3Npb24uY291Y2hkYl90b2tlbiA9IGhleF9obWFjX3NoYTEgQGNmZy5jb3VjaGRiX3NlY3JldCwgQHNlc3Npb24uY291Y2hkYl91c2VybmFtZVxuXG4gICAgICAgIEBqc29uXG4gICAgICAgICAgb2s6dHJ1ZVxuICAgICAgICAgIHVzZXJuYW1lOiBAc2Vzc2lvbi5jb3VjaGRiX3VzZXJuYW1lXG4gICAgICAgICAgcm9sZXM6IEBzZXNzaW9uLmNvdWNoZGJfcm9sZXNcblxuICAgIGNyeXB0byA9IHJlcXVpcmUgJ2NyeXB0bydcbiAgICBoZXhfaG1hY19zaGExID0gKGtleSx2YWx1ZSkgLT5cbiAgICAgIGhtYWMgPSBjcnlwdG8uY3JlYXRlSG1hYyAnc2hhMScsIGtleVxuICAgICAgaG1hYy51cGRhdGUgdmFsdWVcbiAgICAgIGhtYWMuZGlnZXN0ICdoZXgnXG4iXX0=
//# sourceURL=/srv/home/stephane/Artisan/Managed/Telecoms/spicy-action-user/vm-auth.coffee.md