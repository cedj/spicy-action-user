// Generated by CoffeeScript 1.12.1
(function() {
  var PouchDB, debug, seem,
    indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  seem = require('seem');

  PouchDB = require('pouchdb');

  this.name = (require('./package')).name;

  debug = (require('debug'))(this.name);

  this.include = function() {
    var base, prefix, ref, user_db;
    if (((ref = this.cfg.users) != null ? ref.db : void 0) == null) {
      return;
    }
    prefix = (base = this.cfg.users).prefix != null ? base.prefix : base.prefix = 'org.couchdb.user';
    user_db = new PouchDB(this.cfg.users.db);
    this.helper({
      get_user: function() {
        var _id, name;
        if (this.session.couchdb_username == null) {
          return null;
        }
        name = this.session.couchdb_username;
        _id = [prefix, name].join(':');
        debug('get_user', {
          name: name,
          _id: _id
        });
        return user_db.get(_id)["catch"](function() {
          return {
            _id: _id,
            name: name,
            roles: [],
            type: 'user'
          };
        });
      }
    });
    this.helper({
      save_user: seem(function*() {
        var doc;
        if (this.session.couchdb_username == null) {
          return {};
        }
        doc = (yield this.get_user());
        doc.locale = this.session.locale;
        doc.timezone = this.session.timezone;
        if ((doc.database == null) && (this.session.database != null)) {
          doc.database = this.session.database;
        }
        debug('save_user', doc);
        return user_db.put(doc);
      })
    });
    this.helper({
      load_user: seem(function*() {
        var base1, base2, base3, base4, doc, i, len, r, ref1, ref2;
        if (this.session.couchdb_username == null) {
          return;
        }
        if (((ref1 = this.cfg.users) != null ? ref1.db : void 0) == null) {
          return;
        }
        if (this.session == null) {
          return;
        }
        doc = (yield this.get_user());
        if ((base1 = this.session).locale == null) {
          base1.locale = doc.locale;
        }
        if ((base2 = this.session).timezone == null) {
          base2.timezone = doc.timezone;
        }
        if ((base3 = this.session).database == null) {
          base3.database = doc.database;
        }
        if (doc.roles != null) {
          if ((base4 = this.session).couchdb_roles == null) {
            base4.couchdb_roles = [];
          }
          ref2 = doc.roles;
          for (i = 0, len = ref2.length; i < len; i++) {
            r = ref2[i];
            if (indexOf.call(this.session.couchdb_roles, r) < 0) {
              this.session.couchdb_roles.push(r);
            }
          }
        }
      })
    });
    this.on('set_locale', seem(function*(locale) {
      var res;
      this.session.locale = locale;
      res = (yield this.save_user()["catch"]({}));
      return this.ack(res.ok ? {
        ok: true
      } : {
        failed: true
      });
    }));
    this.put('/locale/:locale', seem(function*() {
      var res;
      this.session.locale = this.params.locale;
      res = (yield this.save_user()["catch"]({}));
      return this.json(res.ok ? {
        ok: true
      } : {
        failed: true
      });
    }));
    this.on('set_timezone', seem(function*(timezone) {
      var res;
      this.session.timezone = timezone;
      res = (yield this.save_user()["catch"]({}));
      return this.ack(res.ok ? {
        ok: true
      } : {
        failed: true
      });
    }));
    return this.put('/timezone/:timezone', seem(function*() {
      var res;
      this.session.timezone = this.params.locale;
      res = (yield this.save_user()["catch"]({}));
      return this.json(res.ok ? {
        ok: true
      } : {
        failed: true
      });
    }));
  };

  this.middleware = seem(function*() {
    yield this.load_user()["catch"](function(error) {
      return debug("load_user failed: " + error);
    });
    return this.next();
  });

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC5jb2ZmZWUubWQiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFJO0FBQUEsTUFBQSxvQkFBQTtJQUFBOztFQUFBLElBQUEsR0FBTyxPQUFBLENBQVEsTUFBUjs7RUFDUCxPQUFBLEdBQVUsT0FBQSxDQUFRLFNBQVI7O0VBRVYsSUFBQyxDQUFBLElBQUQsR0FBUSxDQUFDLE9BQUEsQ0FBUSxXQUFSLENBQUQsQ0FBcUIsQ0FBQzs7RUFDOUIsS0FBQSxHQUFRLENBQUMsT0FBQSxDQUFRLE9BQVIsQ0FBRCxDQUFBLENBQWtCLElBQUMsQ0FBQSxJQUFuQjs7RUFFUixJQUFDLENBQUEsT0FBRCxHQUFXLFNBQUE7QUFFVCxRQUFBO0lBQUEsSUFBYywwREFBZDtBQUFBLGFBQUE7O0lBRUEsTUFBQSxnREFBbUIsQ0FBQyxhQUFELENBQUMsU0FBVTtJQUU5QixPQUFBLEdBQWMsSUFBQSxPQUFBLENBQVEsSUFBQyxDQUFBLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBbkI7SUFJZCxJQUFDLENBQUEsTUFBRCxDQUFRO01BQUEsUUFBQSxFQUFVLFNBQUE7QUFDaEIsWUFBQTtRQUFBLElBQU8scUNBQVA7QUFDRSxpQkFBTyxLQURUOztRQUdBLElBQUEsR0FBTyxJQUFDLENBQUEsT0FBTyxDQUFDO1FBQ2hCLEdBQUEsR0FBTSxDQUFDLE1BQUQsRUFBUSxJQUFSLENBQWEsQ0FBQyxJQUFkLENBQW1CLEdBQW5CO1FBQ04sS0FBQSxDQUFNLFVBQU4sRUFBa0I7VUFBQyxNQUFBLElBQUQ7VUFBTSxLQUFBLEdBQU47U0FBbEI7ZUFDQSxPQUNFLENBQUMsR0FESCxDQUNPLEdBRFAsQ0FFRSxFQUFDLEtBQUQsRUFGRixDQUVTLFNBQUE7aUJBQUc7WUFBQyxLQUFBLEdBQUQ7WUFBSyxNQUFBLElBQUw7WUFBVSxLQUFBLEVBQU0sRUFBaEI7WUFBbUIsSUFBQSxFQUFLLE1BQXhCOztRQUFILENBRlQ7TUFQZ0IsQ0FB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T0FBakM7SUFIdUIsQ0FBTCxDQUFwQjtXQUtBLElBQUMsQ0FBQSxHQUFELENBQUsscUJBQUwsRUFBNEIsSUFBQSxDQUFLLFVBQUE7QUFDL0IsVUFBQTtNQUFBLElBQUMsQ0FBQSxPQUFPLENBQUMsUUFBVCxHQUFvQixJQUFDLENBQUEsTUFBTSxDQUFDO01BQzVCLEdBQUEsR0FBTSxDQUFBLE1BQU0sSUFBQyxDQUFBLFNBQUQsQ0FBQSxDQUFZLEVBQUMsS0FBRCxFQUFaLENBQW1CLEVBQW5CLENBQU47YUFDTixJQUFDLENBQUEsSUFBRCxDQUFTLEdBQUcsQ0FBQyxFQUFQLEdBQWU7UUFBQSxFQUFBLEVBQUcsSUFBSDtPQUFmLEdBQTRCO1FBQUEsTUFBQSxFQUFPLElBQVA7T0FBbEM7SUFIK0IsQ0FBTCxDQUE1QjtFQXRGUzs7RUFnR1gsSUFBQyxDQUFBLFVBQUQsR0FBYyxJQUFBLENBQUssVUFBQTtJQUVqQixNQUFNLElBQUMsQ0FBQSxTQUFELENBQUEsQ0FDSixFQUFDLEtBQUQsRUFESSxDQUNHLFNBQUMsS0FBRDthQUNMLEtBQUEsQ0FBTSxvQkFBQSxHQUFxQixLQUEzQjtJQURLLENBREg7V0FJTixJQUFDLENBQUEsSUFBRCxDQUFBO0VBTmlCLENBQUw7QUF0R2QiLCJzb3VyY2VzQ29udGVudCI6WyIgICAgc2VlbSA9IHJlcXVpcmUgJ3NlZW0nXG4gICAgUG91Y2hEQiA9IHJlcXVpcmUgJ3BvdWNoZGInXG5cbiAgICBAbmFtZSA9IChyZXF1aXJlICcuL3BhY2thZ2UnKS5uYW1lXG4gICAgZGVidWcgPSAocmVxdWlyZSAnZGVidWcnKSBAbmFtZVxuXG4gICAgQGluY2x1ZGUgPSAtPlxuXG4gICAgICByZXR1cm4gdW5sZXNzIEBjZmcudXNlcnM/LmRiP1xuXG4gICAgICBwcmVmaXggPSBAY2ZnLnVzZXJzLnByZWZpeCA/PSAnb3JnLmNvdWNoZGIudXNlcidcblxuICAgICAgdXNlcl9kYiA9IG5ldyBQb3VjaERCIEBjZmcudXNlcnMuZGJcblxuKiBkb2MudXNlci5faWQgKHN0cmluZykgYDxjZmcudXNlcnMucHJlZml4Pjo8Y291Y2hkYl91c2VybmFtZT5gXG5cbiAgICAgIEBoZWxwZXIgZ2V0X3VzZXI6IC0+XG4gICAgICAgIHVubGVzcyBAc2Vzc2lvbi5jb3VjaGRiX3VzZXJuYW1lP1xuICAgICAgICAgIHJldHVybiBudWxsXG5cbiAgICAgICAgbmFtZSA9IEBzZXNzaW9uLmNvdWNoZGJfdXNlcm5hbWVcbiAgICAgICAgX2lkID0gW3ByZWZpeCxuYW1lXS5qb2luICc6J1xuICAgICAgICBkZWJ1ZyAnZ2V0X3VzZXInLCB7bmFtZSxfaWR9XG4gICAgICAgIHVzZXJfZGJcbiAgICAgICAgICAuZ2V0IF9pZFxuICAgICAgICAgIC5jYXRjaCAtPiB7X2lkLG5hbWUscm9sZXM6W10sdHlwZTondXNlcid9XG5cbiAgICAgIEBoZWxwZXIgc2F2ZV91c2VyOiBzZWVtIC0+XG4gICAgICAgIHVubGVzcyBAc2Vzc2lvbi5jb3VjaGRiX3VzZXJuYW1lP1xuICAgICAgICAgIHJldHVybiB7fVxuXG4gICAgICAgIGRvYyA9IHlpZWxkIEBnZXRfdXNlcigpXG5cbiAgICAgICAgZG9jLmxvY2FsZSA9IEBzZXNzaW9uLmxvY2FsZVxuICAgICAgICBkb2MudGltZXpvbmUgPSBAc2Vzc2lvbi50aW1lem9uZVxuICAgICAgICBpZiBub3QgZG9jLmRhdGFiYXNlPyBhbmQgQHNlc3Npb24uZGF0YWJhc2U/XG4gICAgICAgICAgZG9jLmRhdGFiYXNlID0gQHNlc3Npb24uZGF0YWJhc2VcblxuICAgICAgICBkZWJ1ZyAnc2F2ZV91c2VyJywgZG9jXG5cbiAgICAgICAgdXNlcl9kYlxuICAgICAgICAgIC5wdXQgZG9jXG5cbiAgICAgIEBoZWxwZXIgbG9hZF91c2VyOiBzZWVtIC0+XG4gICAgICAgIHVubGVzcyBAc2Vzc2lvbi5jb3VjaGRiX3VzZXJuYW1lP1xuICAgICAgICAgIHJldHVyblxuXG4gICAgICAgIHVubGVzcyBAY2ZnLnVzZXJzPy5kYj9cbiAgICAgICAgICByZXR1cm5cblxuICAgICAgICB1bmxlc3MgQHNlc3Npb24/XG4gICAgICAgICAgcmV0dXJuXG5cblJldHJpZXZlIENvdWNoREIgZGF0YSAobG9jYWxlLCB0aW1lem9uZSwgZXh0cmEgcm9sZXMpIGZvciB0aGUgdXNlci5cblxuKiBjZmcudXNlcnMuZGIgKFVSSSkgUG9pbnRzIHRvIHRoZSBgdXNlcnNgIGRhdGFiYXNlLCBpbmNsdWRpbmcgYXV0aGVudGljYXRpb24uXG4qIGNmZy51c2Vycy5wcmVmaXggKHN0cmluZykgUHJlZml4IGZvciB1c2VyIElEcyBbZGVmYXVsdDogYG9yZy5jb3VjaGRiLnVzZXJgXVxuXG4gICAgICAgIGRvYyA9IHlpZWxkIEBnZXRfdXNlcigpXG5cblRoZSB1c2VyIHJlY29yZCBtaWdodCBub3QgZXhpc3QsIG9yIG1pZ2h0IGJlIGVtcHR5LCBldGMuXG5cbiogZG9jLnVzZXIubG9jYWxlIChzdHJpbmcpIHVzZXIgbG9jYWxlXG4qIGRvYy51c2VyLnRpbWV6b25lIChzdHJpbmcpIHVzZXIgdGltZXpvbmVcbiogZG9jLnVzZXIuZGF0YWJhc2UgKHN0cmluZykgdXNlciBkYXRhYmFzZVxuKiBkb2MudXNlci5yb2xlcyAoYXJyYXkpIHVzZXIgcm9sZXNcblxuICAgICAgICBAc2Vzc2lvbi5sb2NhbGUgPz0gZG9jLmxvY2FsZVxuICAgICAgICBAc2Vzc2lvbi50aW1lem9uZSA/PSBkb2MudGltZXpvbmVcbiAgICAgICAgQHNlc3Npb24uZGF0YWJhc2UgPz0gZG9jLmRhdGFiYXNlXG4gICAgICAgIGlmIGRvYy5yb2xlcz9cbiAgICAgICAgICBAc2Vzc2lvbi5jb3VjaGRiX3JvbGVzID89IFtdXG4gICAgICAgICAgZm9yIHIgaW4gZG9jLnJvbGVzIHdoZW4gciBub3QgaW4gQHNlc3Npb24uY291Y2hkYl9yb2xlc1xuICAgICAgICAgICAgQHNlc3Npb24uY291Y2hkYl9yb2xlcy5wdXNoIHJcblxuICAgICAgICByZXR1cm5cblxuICAgICAgQG9uICdzZXRfbG9jYWxlJywgc2VlbSAobG9jYWxlKSAtPlxuICAgICAgICBAc2Vzc2lvbi5sb2NhbGUgPSBsb2NhbGVcbiAgICAgICAgcmVzID0geWllbGQgQHNhdmVfdXNlcigpLmNhdGNoIHt9XG4gICAgICAgIEBhY2sgaWYgcmVzLm9rIHRoZW4gb2s6dHJ1ZSBlbHNlIGZhaWxlZDp0cnVlXG5cbiAgICAgIEBwdXQgJy9sb2NhbGUvOmxvY2FsZScsIHNlZW0gLT5cbiAgICAgICAgQHNlc3Npb24ubG9jYWxlID0gQHBhcmFtcy5sb2NhbGVcbiAgICAgICAgcmVzID0geWllbGQgQHNhdmVfdXNlcigpLmNhdGNoIHt9XG4gICAgICAgIEBqc29uIGlmIHJlcy5vayB0aGVuIG9rOnRydWUgZWxzZSBmYWlsZWQ6dHJ1ZVxuXG4gICAgICBAb24gJ3NldF90aW1lem9uZScsIHNlZW0gKHRpbWV6b25lKSAtPlxuICAgICAgICBAc2Vzc2lvbi50aW1lem9uZSA9IHRpbWV6b25lXG4gICAgICAgIHJlcyA9IHlpZWxkIEBzYXZlX3VzZXIoKS5jYXRjaCB7fVxuICAgICAgICBAYWNrIGlmIHJlcy5vayB0aGVuIG9rOnRydWUgZWxzZSBmYWlsZWQ6dHJ1ZVxuXG4gICAgICBAcHV0ICcvdGltZXpvbmUvOnRpbWV6b25lJywgc2VlbSAtPlxuICAgICAgICBAc2Vzc2lvbi50aW1lem9uZSA9IEBwYXJhbXMubG9jYWxlXG4gICAgICAgIHJlcyA9IHlpZWxkIEBzYXZlX3VzZXIoKS5jYXRjaCB7fVxuICAgICAgICBAanNvbiBpZiByZXMub2sgdGhlbiBvazp0cnVlIGVsc2UgZmFpbGVkOnRydWVcblxuTWlkZGxld2FyZVxuPT09PT09PT09PVxuXG5JbmplY3QgYGxvY2FsZWAsIGB0aW1lem9uZWAsIGFuZCBgZGF0YWJhc2VgIGludG8gdGhlIHNlc3Npb24uXG5cbiAgICBAbWlkZGxld2FyZSA9IHNlZW0gLT5cblxuICAgICAgeWllbGQgQGxvYWRfdXNlcigpXG4gICAgICAgIC5jYXRjaCAoZXJyb3IpIC0+XG4gICAgICAgICAgZGVidWcgXCJsb2FkX3VzZXIgZmFpbGVkOiAje2Vycm9yfVwiXG5cbiAgICAgIEBuZXh0KClcbiJdfQ==
//# sourceURL=/srv/home/stephane/Artisan/Managed/Telecoms/spicy-action-user/index.coffee.md